import nodemailer from 'nodemailer';

console.log('üìß Konfiguracja SMTP:', {
  host: process.env.SMTP_HOST,
  port: process.env.SMTP_PORT,
  secure: process.env.SMTP_SECURE,
  user: process.env.SMTP_USER,
  hasPass: !!process.env.SMTP_PASS
});

const transporter = nodemailer.createTransport({
  host: process.env.SMTP_HOST,
  port: 465, // Sta≈Çy port dla SSL/TLS
  secure: true, // Wymagane dla portu 465
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS,
  },
  tls: {
    rejectUnauthorized: true // Wymagaj prawid≈Çowego certyfikatu SSL
  },
  debug: true,
  logger: true
});

export async function sendAdminNotification({
  orderType,
  companyName,
  orderId
}: {
  orderType: 'profile-removal' | 'review-removal';
  companyName: string;
  orderId: string;
}) {
  const adminEmail = 'd.grzegorczyk@outlook.com'; // Sta≈Çy adres email

  const orderTypeText = orderType === 'profile-removal' ? 'usuniƒôcia profilu' : 'usuniƒôcia opinii';
  
  const mailOptions = {
    from: process.env.SMTP_FROM || process.env.SMTP_USER,
    to: adminEmail,
    subject: `‚ö° Nowe zam√≥wienie: ${orderTypeText} - ${companyName}`,
    html: `
      <h2>Nowe zam√≥wienie w systemie</h2>
      <p>Typ: <strong>${orderTypeText}</strong></p>
      <p>Firma: <strong>${companyName}</strong></p>
      <p>ID zam√≥wienia: <strong>${orderId}</strong></p>
      
    `
  };
  try {
    console.log('üìß Pr√≥ba wys≈Çania powiadomienia:', {
      to: adminEmail,
      from: mailOptions.from,
      subject: mailOptions.subject,
      siteUrl: process.env.NEXT_PUBLIC_SITE_URL
    });

    // Weryfikacja po≈ÇƒÖczenia przed wys≈Çaniem
    try {
      await transporter.verify();
      console.log('‚úÖ Po≈ÇƒÖczenie SMTP zweryfikowane pomy≈õlnie');
    } catch (verifyError) {
      console.error('‚ùå B≈ÇƒÖd weryfikacji SMTP:', verifyError);
      throw verifyError;
    }

    const info = await transporter.sendMail(mailOptions);
    console.log('üìß Powiadomienie wys≈Çane:', {
      messageId: info.messageId,
      response: info.response,
      envelope: info.envelope
    });
    return info;
  } catch (error) {
    console.error('‚ùå B≈ÇƒÖd wysy≈Çki powiadomienia:', error);
    throw error;
  }
}

export async function sendContactEmail({
  name,
  email,
  message
}: {
  name: string;
  email: string;
  message: string;
}) {
  const adminEmail = 'd.grzegorczyk@outlook.com'; // Domy≈õlny adres odbiorcy

  const mailOptions = {
    from: process.env.SMTP_FROM || process.env.SMTP_USER,
    to: adminEmail,
    replyTo: email,
    subject: `üìù Nowa wiadomo≈õƒá kontaktowa od ${name}`,
    html: `
      <div style="font-family: Arial, sans-serif; line-height: 1.5;">
        <h2>Nowa wiadomo≈õƒá kontaktowa</h2>
        <p><strong>Od:</strong> ${name}</p>
        <p><strong>Email:</strong> ${email}</p>
        <hr />
        <div>
          <h3>Wiadomo≈õƒá:</h3>
          <p>${message.replace(/\n/g, '<br>')}</p>
        </div>
      </div>
    `
  };
  
  try {
    console.log('üìß Pr√≥ba wys≈Çania wiadomo≈õci kontaktowej:', {
      to: adminEmail,
      from: mailOptions.from,
      subject: mailOptions.subject
    });

    // Weryfikacja po≈ÇƒÖczenia przed wys≈Çaniem
    try {
      await transporter.verify();
      console.log('‚úÖ Po≈ÇƒÖczenie SMTP zweryfikowane pomy≈õlnie');
    } catch (verifyError) {
      console.error('‚ùå B≈ÇƒÖd weryfikacji SMTP:', verifyError);
      throw verifyError;
    }

    const info = await transporter.sendMail(mailOptions);
    console.log('üìß Wiadomo≈õƒá kontaktowa wys≈Çana:', {
      messageId: info.messageId,
      response: info.response,
      envelope: info.envelope
    });
    return { success: true, info };
  } catch (error) {
    console.error('‚ùå B≈ÇƒÖd wysy≈Çki wiadomo≈õci kontaktowej:', error);
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'WystƒÖpi≈Ç nieznany b≈ÇƒÖd podczas wysy≈Çania wiadomo≈õci' 
    };
  }
}
